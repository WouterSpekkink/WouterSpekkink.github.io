<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>A better csv parser | Wouter A. H. Spekkink</title>
    <meta name="author" content="Wouter A. H. Spekkink">
    <meta name="description" content="My personal website.
">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Bootstrap Table -->
    <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    

    <!-- Styles -->
    
    <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e">
    <link rel="canonical" href="http://localhost:4000/blog/2017/a-better-csv-parser/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">
    <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script>
    <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Wouter </span>A. H. Spekkink</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/repositories/">repositories</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">cv</a>
              </li>

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      
        <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">A better csv parser</h1>
    <p class="post-meta">December 21, 2017</p>
    <p class="post-tags">
      <a href="/blog/2017"> <i class="fas fa-calendar fa-sm"></i> 2017 </a>
        ·  
        <a href="/blog/tag/q-sopra">
          <i class="fas fa-hashtag fa-sm"></i> Q-SoPrA</a>  
          <a href="/blog/tag/technical">
          <i class="fas fa-hashtag fa-sm"></i> Technical</a>  
          <a href="/blog/tag/c">
          <i class="fas fa-hashtag fa-sm"></i> C++</a>  
          <a href="/blog/tag/qt">
          <i class="fas fa-hashtag fa-sm"></i> Qt</a>  
          
        ·  
        <a href="/blog/category/software">
          <i class="fas fa-tag fa-sm"></i> Software</a>  
          

    </p>
  </header>

  <article class="post-content">
    
    <div id="markdown-content">
      <h2 id="background">Background</h2>
<p>Before I get to the main topic of this post, I should offer a bit of background. I am currently working on an integrated software package for the qualitative study of social processes, called Q-SoPrA (an acronym for <strong>So</strong>cial <strong>Pr</strong>ocess <strong>A</strong>nalysis). The program can be used for data entry, data management, hierarchical coding for attributes (think CAQDAS-style coding), coding for network relationships, coding for linkages between events (see the work of <a href="http://www.indiana.edu/~socpsy/ESA/" rel="external nofollow noopener" target="_blank">David Heise</a> for a main source of inspiration in this), abstracting larger events from smaller ones, visualising event graphs, visualising event hierarchies, visualising network graphs, visualising occurrence graphs (similar to <a href="/blog/2017/bi-dynamic-line-graphs/">Bi-Dynamic Line Graphs</a>), and basic analysis. I intend to write some technical as well as non-technical posts about Q-SoPrA and its development. The technical posts will deal primarily with what happens on ‘the back stage’ of the program, that is, discuss the underlying source code. The non-technical posts will focus primarily on Q-SoPrA’s ‘front stage’, discussing its features and how to use them. This post is going to be a technical one.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/welcome_dialog-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/welcome_dialog-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/welcome_dialog-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/welcome_dialog.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" style="margin:auto; display:block" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
  </picture>

</figure>

    </div>
</div>
<div class="caption">
Welcome dialog of Q-SoPrA.
</div>

<p>The main reason for writing the more technical posts is that I have made heavy use of information and advice on writing code that I found online. In fact, I learned almost everything I know about coding from people willing to share their knowledge via the Web (of course, a lot of it was simply learning by doing). Occasionally, I run into difficult problems that I am only able to solve after seeing various posts on websites like Stack Overflow. That being said, the solutions I finally come up with are typically a variant of a particular suggestion that was made online, or a combination of various suggestions. I thought it was a nice idea to give something back, by discussing some solutions for <del>problems</del> challenges I encountered while writing the code for Q-SoPrA, and making those discussion available online, in the hope that someone in search for answers to similar problems might one day stumble upon my posts.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/SO-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/SO-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/SO-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/SO.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" style="margin:auto; display:block" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
  </picture>

</figure>

    </div>
</div>

<h2 id="whats-the-problem">What’s the problem?</h2>
<p>In this post I will discuss something related to the <em>Data Widget</em> that I wrote for Q-SoPrA. I divided Q-SoPrA into several widgets that perform the main tasks of the program (the tasks listed in the background discussion above). The Data Widget handles the user’s interaction with data. In this case, the data take the form of chronologically ordered <em>incidents</em>, which are bracketed, qualitative descriptions of activities. The concept of incidents was introduced during the <a href="https://pubsonline.informs.org/doi/abs/10.1287/orsc.1.3.313" rel="external nofollow noopener" target="_blank">Minnesota Innovation Research Program</a>, although I work with a slightly different idea of what information should be included in an incident:</p>

<ol>
  <li>An indication of the <strong>time of occurrence</strong> (e.g., the hour, the day, the month, the year).</li>
  <li>A <strong>description</strong> of the activity captured in the incident (created by the analyst).</li>
  <li>The <strong>source</strong> of data.</li>
  <li>(Optionally / if available) A fragment of <strong>‘raw’ data</strong>, such as a fragment from an interview transcript, or a passage from a document in which the activity is reported.</li>
  <li>(Optionally) A <strong>comment / memo</strong> written on the incident by the researcher.</li>
</ol>

<p>The Data Widget allows the analyst to create incidents, and store them in a table. To enter / edit data, the user can use a popup dialog. After saving a new incident, a row is added to the Data Widget table, after which the user can still change the location of the incident (i.e., change its position in the chronological order of all incidents), edit its details, duplicate it, or remove it. All changes are immediately written to an sqlite database. See a screenshot of the Data Widget table below.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/data_widget-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/data_widget-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/data_widget-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/data_widget.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" style="margin:auto; display:block" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
  </picture>

</figure>

    </div>
</div>
<div class="caption">
The Data widget.
</div>

<p>One thing that the user can also do is to import an existing data set that was stored in <a href="https://en.wikipedia.org/wiki/Comma-separated_values" rel="external nofollow noopener" target="_blank">csv format</a>. I implemented this future because I have been building data sets before I started using Q-SoPrA myself (I am already using the program while I am building it, which is also a good way to test it). I wanted to have the option to import these existing data sets. The most obvious way to do this (to me, at least) is to store the data sets in csv files, and then import them into Q-SoPrA. <strong>And here is where we finally get to the main topic of this post:</strong> I needed a good way to parse csv files submitted by the user. This in itself is a somewhat trivial task. However, the csv files that I created in the past are a bit ‘messy’, primarily due to the fact that I typically included text from sources of ‘raw data’, such as written news items, and other types of documents. I typically just copy and paste this data, and in a csv file this will often lead to the inclusion of embedded line breaks, and embedded double quotes (e.g., when someone is quoted in a news item).</p>

<p>Most of the relatively simple csv parsers that I have seen will run into problems when trying to read such messy files. After several iterations, I created the set of functions listed in full below. I included a lot of comments in the code to explain what happens at different steps. Most of the code is standard C++ code, but there are also some objects that are based on the Qt library (e.g., QString, QPointer, QMessageBox, QSqlQuery). This is because I used the Qt5 library for the graphical user interface of Q-SoPrA, as well as for interaction with sqlite data sets.</p>

<p>Let’s start with the main function, called <code class="language-plaintext highlighter-rouge">importFromCsv()</code>, (which calls two other customised functions).</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cm">/* 
   This function is designed to facilitate importing data from 
   an external csv file. We read each line of data in turn, 
   check whether we should append any other lines due to 
   embedded line breaks, then cut up the resulting line 
   into tokens, and store these in a data vector before writing 
   the data into our sqlite database.

   We also check whether the file has the correct headers.
*/</span>
<span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">importFromCsv</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// We ask the user to open a file to import from.</span>
  <span class="n">QString</span> <span class="n">csvName</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">::</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">tr</span><span class="p">(</span><span class="s">"Select csv file"</span><span class="p">),</span><span class="s">""</span><span class="p">,</span>
						 <span class="n">tr</span><span class="p">(</span><span class="s">"csv files (*.csv)"</span><span class="p">));</span>
  <span class="c1">// We then create an ifstream object that goes through the file.</span>
  <span class="n">std</span><span class="o">::</span><span class="n">ifstream</span> <span class="n">file</span> <span class="p">((</span><span class="n">csvName</span><span class="p">.</span><span class="n">toStdString</span><span class="p">()).</span><span class="n">c_str</span><span class="p">());</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span> <span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span> <span class="c1">// To store our data in.</span>
  <span class="kt">bool</span> <span class="n">headerFound</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// To be used in a condition further below.</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The buffer will hold each line of data as we read the file.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">buffer</span><span class="p">;</span> 
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getline</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buffer</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// We get the current line/</span>

    <span class="c1">// We should check and handle any extra line breaks in the file.</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">checkLineBreaks</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">extra</span><span class="p">;</span>
      <span class="n">getline</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
      <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">extra</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// We need an object to keep the separate tokens in a line.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">tokens</span><span class="p">;</span> 
    <span class="c1">// We then split the current line into different tokens.</span>
    <span class="n">splitCsvLine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tokens</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
    <span class="cm">/* 
       If we still need to import the header, let's do that first.
       We immediately check if the correct headers were used.
       If not, we report an error and return, letting the user fix the issue.
    */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">headerFound</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"Timing"</span> <span class="o">&amp;&amp;</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"timing"</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">QPointer</span><span class="o">&lt;</span><span class="n">QMessageBox</span><span class="o">&gt;</span> <span class="n">errorBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"&lt;b&gt;ERROR&lt;/b&gt;"</span><span class="p">));</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setInformativeText</span><span class="p">(</span><span class="s">"Expected </span><span class="se">\"</span><span class="s">Timing</span><span class="se">\"</span><span class="s"> in first column."</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">();</span>
	<span class="k">delete</span> <span class="n">errorBox</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"Description"</span> <span class="o">&amp;&amp;</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"description"</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">QPointer</span><span class="o">&lt;</span><span class="n">QMessageBox</span><span class="o">&gt;</span> <span class="n">errorBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"&lt;b&gt;ERROR&lt;/b&gt;"</span><span class="p">));</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setInformativeText</span><span class="p">(</span><span class="s">"Expected </span><span class="se">\"</span><span class="s">Description</span><span class="se">\"</span><span class="s"> "</span>
				     <span class="s">"in second column."</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">();</span>
	<span class="k">delete</span> <span class="n">errorBox</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"Raw"</span> <span class="o">&amp;&amp;</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"raw"</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">QPointer</span><span class="o">&lt;</span><span class="n">QMessageBox</span><span class="o">&gt;</span> <span class="n">errorBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"&lt;b&gt;ERROR&lt;/b&gt;"</span><span class="p">));</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setInformativeText</span><span class="p">(</span><span class="s">"Expected </span><span class="se">\"</span><span class="s">Raw</span><span class="se">\"</span><span class="s"> in third column."</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">();</span>
	<span class="k">delete</span> <span class="n">errorBox</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"Comments"</span> <span class="o">&amp;&amp;</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"comments"</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">QPointer</span><span class="o">&lt;</span><span class="n">QMessageBox</span><span class="o">&gt;</span> <span class="n">errorBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"&lt;b&gt;ERROR&lt;/b&gt;"</span><span class="p">));</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setInformativeText</span><span class="p">(</span><span class="s">"Expected </span><span class="se">\"</span><span class="s">Comments</span><span class="se">\"</span><span class="s"> in "</span>
				     <span class="s">"fourth column."</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">();</span>
	<span class="k">delete</span> <span class="n">errorBox</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"Source"</span> <span class="o">&amp;&amp;</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s">"source"</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">QPointer</span><span class="o">&lt;</span><span class="n">QMessageBox</span><span class="o">&gt;</span> <span class="n">errorBox</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QMessageBox</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"&lt;b&gt;ERROR&lt;/b&gt;"</span><span class="p">));</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">setInformativeText</span><span class="p">(</span><span class="s">"Expected </span><span class="se">\"</span><span class="s">Source</span><span class="se">\"</span><span class="s"> in "</span>
				     <span class="s">"fifth column."</span><span class="p">);</span>
	<span class="n">errorBox</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">();</span>
	<span class="k">delete</span> <span class="n">errorBox</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="cm">/* 
	 If we checked all headers and imported the header correctly,
	 we can set the headerFound bool to true, so that this block 
	 is skipped in all subsequent line reads.
      */</span>
      <span class="n">headerFound</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// This is the block that is run after the header was</span>
      <span class="n">already</span> <span class="n">imported</span><span class="p">.</span>
      <span class="c1">// We iterate through the tokens and push them into the row vector.</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">row</span><span class="p">;</span>
      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span> 
      <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">tokens</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">row</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// Then we push the row vector into the data vector.</span>
      <span class="n">data</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="cm">/* 
     Writing to sqlite databases is quite slow, so if the 
     csv-file is large, it will take a while. We use a progress bar 
     to report to the user how much we have already imported 
     into the sqlite database.
  */</span>
  <span class="n">loadProgress</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ProgressBar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="n">loadProgress</span><span class="o">-&gt;</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">Qt</span><span class="o">::</span><span class="n">WA_DeleteOnClose</span><span class="p">);</span>
  <span class="n">loadProgress</span><span class="o">-&gt;</span><span class="n">setModal</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="n">loadProgress</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">();</span>

  <span class="cm">/* 
     We need a pointer to the data widget to determine the 
     number of rows already in the table
  */</span>
  <span class="n">DataWidget</span> <span class="o">*</span><span class="n">dw</span> <span class="o">=</span> <span class="n">qobject_cast</span><span class="o">&lt;</span><span class="n">DataWidget</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">stacked</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">dw</span><span class="o">-&gt;</span><span class="n">updateTable</span><span class="p">();</span> <span class="c1">// A function to make sure all table rows are read.</span>
  <span class="cm">/* 
     Since imported rows are appended to the end of the data base, 
     we can assume that the order variable is the number of 
     existing rows + 1.
  */</span>
  <span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="n">dw</span><span class="o">-&gt;</span><span class="n">incidentsModel</span><span class="o">-&gt;</span><span class="n">rowCount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span> <span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">it</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">it</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">it</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We create all the necessary variables and write them to the table.</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">currentRow</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
    <span class="n">QString</span> <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">currentRow</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">QString</span> <span class="n">description</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">currentRow</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">QString</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">currentRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">QString</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">currentRow</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
    <span class="n">QString</span> <span class="n">source</span> <span class="o">=</span> <span class="n">QString</span><span class="o">::</span><span class="n">fromStdString</span><span class="p">(</span><span class="n">currentRow</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
    <span class="n">QSqlQuery</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QSqlQuery</span><span class="p">;</span> <span class="c1">// For this we use the QSqlQuery object.</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">"INSERT INTO incidents "</span>
		   <span class="s">"(ch_order, timestamp, description, raw, comment, "</span>
		   <span class="s">"source, mark) "</span>
		   <span class="s">"VALUES "</span>
		   <span class="s">"(:order, :timestamp, :description, :raw, :comment, "</span>
		   <span class="s">":source, :mark)"</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":order"</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":timestamp"</span><span class="p">,</span> <span class="n">timeStamp</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":description"</span><span class="p">,</span> <span class="n">description</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":raw"</span><span class="p">,</span> <span class="n">raw</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":comment"</span><span class="p">,</span> <span class="n">comment</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":source"</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">bindValue</span><span class="p">(</span><span class="s">":mark"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">query</span><span class="o">-&gt;</span><span class="n">exec</span><span class="p">();</span>		   
    <span class="n">order</span><span class="o">++</span><span class="p">;</span> <span class="c1">// Make sure that we increment the order variable.</span>
    <span class="n">loadProgress</span><span class="o">-&gt;</span><span class="n">setProgress</span><span class="p">(</span><span class="n">order</span><span class="p">);</span> <span class="c1">// Set progress and report</span>
    <span class="n">qApp</span><span class="o">-&gt;</span><span class="n">processEvents</span><span class="p">();</span> <span class="c1">// Make sure that the progress is visible</span>
    <span class="k">delete</span> <span class="n">query</span><span class="p">;</span> <span class="c1">// Memory management</span>
  <span class="p">}</span>
  <span class="n">loadProgress</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span> <span class="c1">// We can close the progress bar.</span>
  <span class="k">delete</span> <span class="n">loadProgress</span><span class="p">;</span> <span class="c1">// Memory management</span>
  <span class="c1">// The imported data won't be visible unless we run the following lines.</span>
  <span class="n">dw</span><span class="o">-&gt;</span><span class="n">incidentsModel</span><span class="o">-&gt;</span><span class="n">select</span><span class="p">();</span>
  <span class="n">dw</span><span class="o">-&gt;</span><span class="n">updateTable</span><span class="p">();</span>
  <span class="c1">// We should also update the attributes widget at this point. </span>
  <span class="n">AttributesWidget</span> <span class="o">*</span><span class="n">aw</span> <span class="o">=</span> <span class="n">qobject_cast</span><span class="o">&lt;</span><span class="n">AttributesWidget</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">stacked</span><span class="o">-&gt;</span><span class="n">widget</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span> 
  <span class="n">aw</span><span class="o">-&gt;</span><span class="n">retrieveData</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<h3 id="handling-embedded-line-breaks">Handling embedded line breaks</h3>

<p>So, what exactly happens here? Well, I won’t discuss all the lines of code in detail, but I will discuss the ones most important to the problem at hand (parsing ‘messy’ csv-files). The basic logic of the function is that we read a csv file line by line, and that we process each line in turn. One challenge that we might encounter while parsing ‘messy’ csv files is the presence of embedded line breaks. This means that one cell includes multiple lines of data, separated by so-called line breaks. See the screenshot below for an example. In the second row of data (below the header), we see a couple of line breaks.</p>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        <figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/embedded_line_breaks-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/embedded_line_breaks-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/embedded_line_breaks-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/embedded_line_breaks.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" style="margin:auto; display:block" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">
  </picture>

</figure>

    </div>
</div>
<div class="caption">
Embedded line breaks.
</div>

<p>The line breaks are even more obvious if we open our csv file with a basic text editor. We will see something this:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
timing,description,raw,comments,source
1,test1,"Let's make
this

example",,s1
2,test2,What?,,s2
3,test3,Nothing,,s3

</code></pre></div></div>
<details>
<summary>Click here for some additional info on what we see here</summary>
<blockquote>
Looking at the text fragment above actually gives us a pretty good idea of how a csv file is typically structured. One thing to notice is that we see a lot of commas that we did not see in the original screenshot. These commas are used to separate between different columns of data, and are the reason why csv files are often referred to as comma-delimited files (actually, csv stands for <b>C</b>omma <b>S</b>eparated <b>V</b>alue). In the file above, we sometimes see two commas. This simply means that the cell between those commas is empty. We also see that cells with line breaks in them are double quoted, while we did not add double quotes in our original file. Double quotes are often used for text fields if there is something special about them, such as the presence of line breaks, or the presence of embedded commas (commas that do not indicate additional columns, but simply break up sentences into different segments). 
</blockquote>
</details>
<p><br></p>

<p>If we use the C++ <code class="language-plaintext highlighter-rouge">getline()</code>function to read the lines in this file, then the first line it will read is <code class="language-plaintext highlighter-rouge">"timing","description","raw","comments","source"</code>, the second line it will read is <code class="language-plaintext highlighter-rouge">1,"test1","Let's make</code>, the third line <code class="language-plaintext highlighter-rouge">this</code>, and so on. This is a bit of a problem, because we actually want the second line of data to be something like <code class="language-plaintext highlighter-rouge">1,"test1","Let's make this example",,"s1"</code>. Fortunately, the <a href="http://www.creativyst.com/Doc/Articles/CSV/CSV01.htm#FileFormat" rel="external nofollow noopener" target="_blank">csv standard</a> prescribes that we embed text fields with line breaks in them in double quotes. We can use the number of double quotes on a given line of data as clue about whether or not that line might have line breaks embedded in them. For example, in the second line of data, we find only 1 double quote, which suggest that we might not be finished reading the line (otherwise we should have encountered a matching closing double quote somewhere down the line).</p>

<p>One thing we could do whenever we encounter an unequal number of quotes, is to check if we can perhaps find the missing quotes in the next line(s) of data. If this indeed the case (it should be the case), then we can append these other lines to our current line in order to complete it.</p>

<p>That is what happens in the <code class="language-plaintext highlighter-rouge">while (checkLineBreaks(buffer) == true)</code> loop. ‘checkLineBreaks(QString line)’ is an additional function that I wrote, and that returns true if the parser thinks there is an embedded line break in the current line. I show the while loop and the accompanying ‘checkLineBreaks(QString line)’ function below.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="k">while</span> <span class="p">(</span><span class="n">checkLineBreaks</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">extra</span><span class="p">;</span>
  <span class="n">getline</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
  <span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">extra</span><span class="p">;</span>
<span class="p">}</span>
	
<span class="cm">/* 
   Function to check for line breaks in current line of imported csv file.
   The logic is that a finished line of data will always have an 
   equal number of double quotes ("). If this is not the case, we can assume 
   that another line of data should be appended. 
*/</span>
<span class="kt">bool</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">checkLineBreaks</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">lineBreak</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// This is the variable that will be returned.</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">size_type</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">line</span><span class="p">.</span><span class="n">length</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* 
       If we did not find a quote yet, and we find one,
       we set the lineBreak variable to true.
    */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lineBreak</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lineBreak</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="cm">/*
	If we then find another quote, 
	we can assume that no embedded line break exists.
      */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">lineBreak</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lineBreak</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// After reading the line, we return the result.</span>
  <span class="k">return</span> <span class="n">lineBreak</span><span class="p">;</span>  
<span class="p">}</span></code></pre></figure>

<p>The <code class="language-plaintext highlighter-rouge">buffer</code> object is the original line of data that we are currently reading. If we find a line break in this object, then we create a new object <code class="language-plaintext highlighter-rouge">extra</code>, put the next line of data in it, and append it to <code class="language-plaintext highlighter-rouge">buffer</code> (we also include two line breaks to mimic the original line break; why I chose to use two has to do with something that is not important right now). Since we are using a while loop, the program will keep doing this as long as it encounters line breaks in the current version of <code class="language-plaintext highlighter-rouge">buffer</code>. Pretty neat, huh?</p>

<h3 id="handling-text-fields-with-embedded-double-quotes">Handling text fields with embedded double quotes</h3>

<p>Another challenge we are likely to encounter when reading ‘messy’ csv files is the inclusion of text fields (cells with longer strings of text in them) that might also have embedded double quotes, for example when the text includes a fragment where someone is quoted. More importantly, they might have embedded commas that separate different parts of a sentence. The problem with this is that we also use commas to distinguish between different columns of our csv file, and we somehow need to keep the two different types of comma separate. Let us first slightly adapt our example file to demonstrate what happens to the csv file if we embed double quotes and commas in a text field.</p>

<p><em>Just as a note on the side:</em> Depending on what text editor you use, you might not actually see the additional double quotes shown below. The csv standard prescribes that fields with embedded quotes are themselves quoted, and that single embedded quotes are always represented by two double quotes. However, some text editors may parse these double quotes out when you open the file, based on this standard.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timing,description,raw,comments,source
1,test1,"Let’s make this example",,"s1"
2,test2,"If there is one thing I hate, it is a single "" What about you?",,"s2"
3,test3,"""Nothing interesting really happened"", said Toby the magic purple elephant.",,"s3"
4,test4,"What about commas, huh?",,"s4"
</code></pre></div></div>
<p>In the second line below the header, you’ll find a text cell with a single embedded double quote. As you can see, it is represented by two double quotes rather than one. In the second to last line of data, we find an example of someone being quoted. In the last line we find an embedded comma. For a simple csv parser, these are all quite challenging cases to deal with appropriately, especially if we find them in some combination.</p>

<p>In the csv parser that I wrote, these cases are all handled by the <code class="language-plaintext highlighter-rouge">splitCsvLine(&amp;tokens, buffer)</code> function. In the first block of code I included above, the function is called right after we have checked the lines for any line breaks. In other words, the version of buffer that is fed into the <code class="language-plaintext highlighter-rouge">splitCsvLine(&amp;tokens, buffer)</code> function is already a complete version, where all line breaks have been dealt with.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cm">/* 
   Function to split csv lines.
   Here, we should be careful with embedded quotes in text fields.
   Text fields in csv-files are marked by quotes.
   We repeatedly check whether or not we are in a text field and 
   respond accordingly.

   We also clean up the line of text a bit before we cut it up.
*/</span>
<span class="kt">void</span> <span class="n">MainWindow</span><span class="o">::</span><span class="n">splitCsvLine</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">tokens</span><span class="p">,</span>
			      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">inTextField</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// To check whether or not we are in a text field.</span>
  <span class="cm">/* 
     The next two variables are to make sure that 
     we cut out clean segments of the line.
  */</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">size_type</span> <span class="n">stringLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">size_type</span> <span class="n">previousPos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// We use this integer to count the number of quotes in a line so far.</span>
  <span class="kt">int</span> <span class="n">quoteCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
  <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">size_type</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">line</span><span class="p">.</span><span class="n">length</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">quoteCount</span><span class="o">++</span><span class="p">;</span> <span class="c1">// If we found a quote, we increment this variable.</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inTextField</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* 
	 Finding a quote will mean that we are now 
	 in a text field if we weren't already.
      */</span>
      <span class="n">inTextField</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">previousPos</span><span class="o">++</span><span class="p">;</span> <span class="c1">// We don't want to include the quote itself.</span>
      <span class="n">stringLength</span><span class="o">--</span><span class="p">;</span>
      <span class="cm">/* 
	 If we are in a text field, and we encounter another quote, then we
	 should first check if it is accompanied by yet another pair of quotes. 
	 This is based on the fact that csv files (if written correctly), 
	 always use double quotes for
	 quotes that are embedded in text fields. 

	 We also double check by checking if the current amount of 
	 quotes is divisible by 2, that is, if we have an 
	 equal number of quotes.
      */</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">inTextField</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">&amp;&amp;</span>
	       <span class="n">line</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'"'</span> <span class="o">&amp;&amp;</span> <span class="n">quoteCount</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If these conditions hold, it means that we have now left the text field.</span>
      <span class="n">inTextField</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">stringLength</span><span class="o">--</span><span class="p">;</span> <span class="c1">// We don't want to include the quote itself.</span>
    <span class="p">}</span>
    <span class="c1">// If we encounter a comma, it means that we have encountered a new token.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inTextField</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">','</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We remove any white spaces before the start of this new token.</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">previousPos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">previousPos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stringLength</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// We create a substring here.</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tempString</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">previousPos</span><span class="p">,</span> <span class="n">stringLength</span><span class="p">);</span>
      <span class="c1">// In case we have any remaining double quotes, let us remove them.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tempString</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">tempString</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">tempString</span><span class="p">.</span><span class="n">end</span><span class="p">();)</span> <span class="p">{</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">it</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">it</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">tempString</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">it</span><span class="o">++</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// And then we store the resulting string as a new token.</span>
      <span class="n">tokens</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">tempString</span><span class="p">);</span>
      <span class="n">previousPos</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// We set a new starting position for the next token.</span>
      <span class="n">stringLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// And we reset the string length.</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">stringLength</span><span class="o">++</span><span class="p">;</span> <span class="c1">// We increment the string length as we go on.</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">// After we finish reading the line, we should still include the last token.</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">previousPos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">previousPos</span><span class="o">++</span><span class="p">;</span>
    <span class="n">stringLength</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tempString</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">previousPos</span><span class="p">,</span> <span class="n">stringLength</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tempString</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">tempString</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">it</span> <span class="o">!=</span> <span class="n">tempString</span><span class="p">.</span><span class="n">end</span><span class="p">();)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">it</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">it</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">tempString</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">it</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">tokens</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">tempString</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>This function reads through the object <code class="language-plaintext highlighter-rouge">buffer</code> (which is a string) character by character, and eventually pulls different substrings from the <code class="language-plaintext highlighter-rouge">buffer</code> object that we use as tokens to be written to our database. Near the beginning of this function, we define a bool variable <code class="language-plaintext highlighter-rouge">bool inTextField</code> that we use to check whether we are currently reading characters that are part of a text field. The idea behind this is very simple: If the bool is set to false, and we encounter a double quote, then this is taken as a sign that we are, from now on, inside a text field. As long as we are inside a text field, any commas we encounter will be ignored, and any double quotes we encounter will be handled in a special way.</p>

<p>So, what happens once we read the last version of our example csv file, focusing only on the way that double quotes and embedded commas are handled? Let’s start first with the line of data where we have one embedded quote. We first hit the double quote before the word “If”, setting <code class="language-plaintext highlighter-rouge">quoteCount</code> to 1, and setting <code class="language-plaintext highlighter-rouge">inTextField</code> to true. We then hit the first double quote after the word “single”. We set <code class="language-plaintext highlighter-rouge">quoteCount</code> to 2, and given that we are now in a text field, we check whether both the current character at position <em>i</em>, and the next character at position <em>i + 1</em> are double quotes. The <code class="language-plaintext highlighter-rouge">} else if () {</code> statement returns false, because we find a double quote at both positions, so we continue. We immediately encounter the second double quote after the word “single”. Thus, we set <code class="language-plaintext highlighter-rouge">quoteCount</code> to 3, and check the conditional again. In this case, we do not find a double quote at position <em>i + 1</em> (we find a “.” instead), but the last part of the conditional still makes it return false, since 3 % 2 does not equal 0. Just in case you don’t know the meaning of the % symbol in this context, it means that we take the remainder after dividing <code class="language-plaintext highlighter-rouge">quoteCount</code> by 2. Whenever <code class="language-plaintext highlighter-rouge">quoteCount</code> is an even number, this statement will return 0. Given that the <code class="language-plaintext highlighter-rouge">} else if() {</code> still returns false, we continue again. We encounter the last quote of this line after “them.”. We set <code class="language-plaintext highlighter-rouge">quoteCount</code> to 4, and we check the conditional again, which in this case returns true, since (1) we are currently in a text field, (2), at position <em>i</em> we find a double quote, and at position <em>i + 1</em> we do not, and the <code class="language-plaintext highlighter-rouge">quoteCount % 2</code> equals 0. This means that we have now (correctly) decided that we are no longer in a text field, and that we can continue treating commas and double quotes as we normally would.</p>

<p>Let’s consider the second to last line of data next. After two columns, we hit the three consecutive double quotes. The first of these sets the <code class="language-plaintext highlighter-rouge">inTextField</code> bool to true. The two other double quotes don’t do anything but increment the <code class="language-plaintext highlighter-rouge">quoteCount</code> object, since the first of them is followed by another double quote, and since the second of them brings <code class="language-plaintext highlighter-rouge">quoteCount</code> to 3, an unequal number. We continue to the two double quotes after the word “happened”, which again do nothing, since the first is followed by another double quote, and since the second brings <code class="language-plaintext highlighter-rouge">quoteCount</code> to an unequal number (5). The last double quote is encountered after “elephant.”. This one brings <code class="language-plaintext highlighter-rouge">quoteCount</code> to a total of 6 for this line, and since it is not followed by another double quote, the function decides that we have finished reading the current text field.</p>

<p>Now, let’s discuss the last line of data in the file. This case is quite simple. Once we encounter the first double quote, <code class="language-plaintext highlighter-rouge">inTextField</code> is set to true, and therefore the comma we encounter after the word “commas” is ignored. After we encounter the second double quote, we set <code class="language-plaintext highlighter-rouge">inTextField</code> to false again, and the commas that we encounter in the remainder of the line are handled as delimiting commas.</p>

<p>Thus, the problematic cases we discussed earlier are handled quite well. In fact, I am still quite surprised myself how flexible this set of functions is with messy data.</p>

<h2 id="closing-comments">Closing comments</h2>

<p>As mentioned before, the functions discussed above take inspiration from various comments I encountered while browsing sites like Stack Overflow, and it would be nice to acknowledge everyone who has shared the knowledge that I made use of to write these functions, but I honestly do not remember where I found the different snippets of information. I guess I’ll just have to thank the Stack Overflow community at large.</p>

<p>The functions were written and repeatedly revised over quite a long period of time. After all this time, I had to study them in detail myself to understand their underlying logic again. There might still be important details that I forgot to mention here. However, in these cases “the proof of the pudding is in the eating.” It should be easy to integrate these functions in your own software, and try them out for yourself.</p>

<p>I hope they turn out to be useful to others!</p>


    </div>
  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/retrieval-augmentation-with-literature/">Retrieval augmentation with literature</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/retrieval-augmentation-with-literature/">Retrieval augmentation with literature</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/simple-universal-bookmarking/">Simple universal bookmarking</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/using-llms-with-retrieval-augmentation-through-langchain/">Using LLMs with retrieval augmentation through LangChain</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/writing-academic-papers-with-org-mode/">Writing academic papers with org-mode</a>
  </li>

</div>

      
    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        © Copyright 2023 Wouter A. H. Spekkink. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script>

  <!-- Bootstrap Table -->
  <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script>

  <!-- Load Common JS -->
  <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script>
  <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script>
  <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
